import pytest
from brownie import accounts, MockReceiver
import time

VALID_MULTI_PROOF = "000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000007C000000000000000000000000000000000000000000000000000000000000007604915AD2A83E334030BD2841825049F77CE42F98211C1B3369034B342BDB18A3CFACDE335819A4A7C43077B3FE11A427B3142FC55E25C6BC40F61C1EE86DD5A07EA0C5E0D83A8970E1F6135EE88A5CF826868E4256931E9149F485C6E7A020823FA8F6B190BD239F561FC3973C8D46C4E24F0639521ECD4F3E92FAE966CD79194E878F73021E2A10507408DBF8618AE3E4B73F94816F49D727E6FB95389322F3B3F02642D9E70D5C1C493A4F732BFE9C9B95A4A42651703B816EDCFC8FADA531200000000000000000000000000000000000000000000000000000000000015450000000000000000000000000000000000000000000000000000000060AF93DF0000000000000000000000000000000000000000000000000000000008BDFD54D3FB166B97CE4A66310369589FCE332C6822B640AAB350B725CE6917EA0133F96206F2FFDFBB93B83BD917B05B13CA59C12330268611242F5FD5734E673079159FB9C7533CAF1D218DA3AF6D277F6B101C42E3C3B75D784242DA663604DD53C29028C2AEF0CDD1F9746B1B2DEFFA898BFDE0B70CD58BAFB6211FABC8623F749400000000000000000000000000000000000000000000000000000000000001C00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001C0000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000004404172DF5060CEDD070ED6CF1ABB01C3A510DE261A7C608CFEA8439175ECCDB4C100A35E2097E8849FE12FA43B704B839BA7B7D92F381494BFCE65C65099278B82000000000000000000000000000000000000000000000000000000000000001B00000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000106E080211451500000000000022480A2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F122408011220C90C2948C1C725537F856CC4EFFC80C8F345B06EBF094AD4AA0EFE90542B31662A0C08E0A7BE850610F6CDB0D103320962616E64636861696E006FC97790B34262AC9A1E40680B28C6BC16007B6444AA1635DC0F2656CA8BA997471AA11928C40949DB1C3CF91296234846A69C53CD9602FEC46C23E17C07DE32000000000000000000000000000000000000000000000000000000000000001C00000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000106E080211451500000000000022480A2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F122408011220C90C2948C1C725537F856CC4EFFC80C8F345B06EBF094AD4AA0EFE90542B31662A0C08E0A7BE850610EC97F0D403320962616E64636861696E00498D405422AC9AFFC10B5DBF00992496226B0436CAF9CC604758605B39A104BC3F7FDA04C70AA4E867CFE22EA476DB2001ED8E36B33819682B521BACEDF75012000000000000000000000000000000000000000000000000000000000000001C00000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000106E080211451500000000000022480A2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F122408011220C90C2948C1C725537F856CC4EFFC80C8F345B06EBF094AD4AA0EFE90542B31662A0C08E0A7BE85061082BBD0D203320962616E64636861696E0033802F79AD672E741D3FC3B80EB668398D4DA6982647A7DA084DA0F89B724688304842D70750586009E2292DFF159231BDB09072FF0F7269009B50B6A07D37E2000000000000000000000000000000000000000000000000000000000000001B00000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000106E080211451500000000000022480A2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F122408011220C90C2948C1C725537F856CC4EFFC80C8F345B06EBF094AD4AA0EFE90542B31662A0C08E0A7BE8506108AC6A1D303320962616E64636861696E0000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000005E00000000000000000000000000000000000000000000000000000000000001545000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000003EF00000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001A000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000060AF73DE0000000000000000000000000000000000000000000000000000000060AF73E0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001E0000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F0000000342544300000000000F424000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000092B6826F20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000144CEE7687A25A2E57EF6C8A0563C71E0AC206ED38F660868E0A6E35AF5DAC4F31F9000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000144CEB739BB22F48B7F3053A90BA2BA4FE07FAB262CADF8664489565C50FF505B8BD000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000144C66DB7A4464DF7D7A956428F5D49FB034A860510035797D1B714D7348BDB7EA5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000B000000000000000000000000000000000000000000000000000000000000144CF054C5E2412E1519951DBD7A60E2C5EDE41BABA494A6AF6FD0B0BAC4A4695C41000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000015000000000000000000000000000000000000000000000000000000000000154455D62CF6B3BCE22AD491FBB1137A6FDB715AD03347D385A705505C924DC0446400000000000000000000000000000000000000000000000000000000000005E000000000000000000000000000000000000000000000000000000000000015450000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000144C00000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001A000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000060AF92100000000000000000000000000000000000000000000000000000000060AF9214000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001E0000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F0000000342544300000000000186A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000ED1889260000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000144C8C37B4BACA5C1B8ABD886636BD64F18BE696F98560DC01D623DB52BAE8813E2F000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000144CEB739BB22F48B7F3053A90BA2BA4FE07FAB262CADF8664489565C50FF505B8BD000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000144C66DB7A4464DF7D7A956428F5D49FB034A860510035797D1B714D7348BDB7EA5600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000B000000000000000000000000000000000000000000000000000000000000144CF054C5E2412E1519951DBD7A60E2C5EDE41BABA494A6AF6FD0B0BAC4A4695C41000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000015000000000000000000000000000000000000000000000000000000000000154455D62CF6B3BCE22AD491FBB1137A6FDB715AD03347D385A705505C924DC04464"


EXPECTED_MULTI_RELAY_RESULT = [
    [
        "from_scan", 
        1, 
        "0x0000000342544300000000000f4240", 
        1, 
        1, 
        1, 
        1, 
        1622111198, 
        1622111200, 
        1, 
        "0x000000092b6826f2"
    ],
    [
        "from_scan", 
        1, 
        "0x0000000342544300000000000186a0", 
        1, 
        1, 
        2, 
        1, 
        1622118928, 
        1622118932, 
        1, 
        "0x00000000ed188926"
    ],
]

# Deploy MockReceiver contract
@pytest.fixture(scope="module")
def mockreceiver(bridge):
    return accounts[0].deploy(MockReceiver, bridge)


def test_bridge_relayandmultiverify_success(bridge, mockreceiver):
    tx = mockreceiver.relayAndMultiSafe(VALID_MULTI_PROOF)
    assert tx.status == 1
    assert bridge.blockDetails(5445) == [
        "0xEA0C5E0D83A8970E1F6135EE88A5CF826868E4256931E9149F485C6E7A020823",
        1622119391,
        146668884,
    ]
    for i in range(len(EXPECTED_MULTI_RELAY_RESULT)):
        res = mockreceiver.latestResults(i)
        assert [
            res["clientID"],
            res["oracleScriptID"],
            res["params"],
            res["askCount"],
            res["minCount"],
            res["requestID"],
            res["ansCount"],
            int(res["requestTime"]),
            int(res["resolveTime"]),
            res["resolveStatus"],
            res["result"],
        ] == EXPECTED_MULTI_RELAY_RESULT[i]
