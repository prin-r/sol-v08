import pytest
import brownie
from brownie import accounts, Bridge, MockReceiver
import time

SINGLE_VALIDATOR_SET = [
    ["0xaAA22E077492CbaD414098EBD98AA8dc1C7AE8D9", 100],
]

VALID_MULTI_PROOF = "0x00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000002E445CD72E61F5D79ECC26F8CA024FB86D3A6A925071DDF73CB79D1BBAEA3C5132C47359DC797788AA7A77A27B8B40BF23F5EF60594E34253373DDFB76251240C43866A2417EB63733CC9B7A5CB89EDC98F308EE066FFE6E59E0C6CBE22B700704E2B6A7E0F44ED9C179A47A40F93D5824189A5426D6C3F77692DE28E50E20A33DDAF86E0275A883BDCA2276CC1FE523F4E43C50C5612EB996623D287F80B84CFDA32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E48DFB8B1F245FAB852685BEEAB33EBB09CD93EA77BDDD9B73AEB833FC2FC028B1EF4C4CD033DCB00C0B471C30B35ABC13C2A8B682D70CCA2CC74DFBBEE46CDFAA54CCB0556B3BD0C34805C986FED66F1BDF3FC989BA01F2F34470EE3A7DA71016E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D0CF1E6ECE60E49D19BB57C1A432E805F39BB4F65C366741E4F03FA54FBD9071400000000000000000000000000000000000000000000000000000000000001A0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000203D2DD609088F4A660225913296A5D392051FCCC6CCBA9C74E46DE2A5E6CBF3D7733483953F4283ADF7DEE7D082601B641B14A85B71D4FE7D6584BF2FED620904000000000000000000000000000000000000000000000000000000000000001B00000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000106E080211E40200000000000022480A2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F12240A2060F3ED6948B113B8B528C6F79D33F5A40544AD5330132A2ABFD47A18A147D84910012A0C0890D2D9FA0510C8BD9DD901320962616E64636861696E000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000007A00000000000000000000000000000000000000000000000000000000000000EE0000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000002E400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001E000000000000000000000000000000000000000000000000000000000000001CE000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002200000002464200000010324B4D43424C415A4D3554453256504700000000000003E800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000005F566759000000000000000000000000000000000000000000000000000000005F56675C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000004506A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000002A2C1302062844B84E96DB63A6924AA593F66A9E8A535CF657DE4D1F86CFEF8058B00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000002A2301E07C9ED7015E98CBC234AEB87003C05AF21F4273EEE8C3F55BF668AECB4D000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000002A2B6936B0BB87A5579BD57C790C2A191ECF70C707F2C7493356AFD32489C48B07C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000002A261E55C6C45B1A9E9B86C32BB19BF819A7CB684AABD7FA4BC8C87792DAE52D38F00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002A25D52D5033592D37ECCA65B227BF3AF502967E0833BB867DBBE6AA0848285BFEB00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000002E33DE917D101D39159FB448360B702BC1C8778975B81CEBC8BE73C7F8DA3DE3A79000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000002E400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001E00000000000000000000000000000000000000000000000000000000000000247000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002400000004474F4F4700000010324B4D43424C415A4D3554453256504700000000000003E80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000005F566816000000000000000000000000000000000000000000000000000000005F56681900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000184700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000002A21646BAB59AD79C62A66123C7CBF0B1CE8830336C5F3CB5CC689CC45C5BAA140C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000002A28C3D3FC25F23B7F63ED18C8900FC40582E7ED488B71C7FE19126DCCCDCE08D7600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000002A2B6936B0BB87A5579BD57C790C2A191ECF70C707F2C7493356AFD32489C48B07C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000002A261E55C6C45B1A9E9B86C32BB19BF819A7CB684AABD7FA4BC8C87792DAE52D38F00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002A25D52D5033592D37ECCA65B227BF3AF502967E0833BB867DBBE6AA0848285BFEB00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000002E33DE917D101D39159FB448360B702BC1C8778975B81CEBC8BE73C7F8DA3DE3A79000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000002E400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001E000000000000000000000000000000000000000000000000000000000000002A2000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000044141504C00000010324B4D43424C415A4D3554453256504700000000000003E80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000005F5668A4000000000000000000000000000000000000000000000000000000005F5668A700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000001D880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000002A2420CE1DDED95E4D5240EEB397AAC8C82C372028466EBC5DC3919A0D22C75EDE800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000002A28C3D3FC25F23B7F63ED18C8900FC40582E7ED488B71C7FE19126DCCCDCE08D7600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000002A2B6936B0BB87A5579BD57C790C2A191ECF70C707F2C7493356AFD32489C48B07C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000002A261E55C6C45B1A9E9B86C32BB19BF819A7CB684AABD7FA4BC8C87792DAE52D38F00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002A25D52D5033592D37ECCA65B227BF3AF502967E0833BB867DBBE6AA0848285BFEB00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000002E33DE917D101D39159FB448360B702BC1C8778975B81CEBC8BE73C7F8DA3DE3A79"

INVALID_MULTI_PROFF_ORACLE_STATE = "0x00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000003E445CD72E61F5D79ECC26F8CA024FB86D3A6A925071DDF73CB79D1BBAEA3C5132C47359DC797788AA7A77A27B8B40BF23F5EF60594E34253373DDFB76251240C43866A2417EB63733CC9B7A5CB89EDC98F308EE066FFE6E59E0C6CBE22B700704E2B6A7E0F44ED9C179A47A40F93D5824189A5426D6C3F77692DE28E50E20A33DDAF86E0275A883BDCA2276CC1FE523F4E43C50C5612EB996623D287F80B84CFDA32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E48DFB8B1F245FAB852685BEEAB33EBB09CD93EA77BDDD9B73AEB833FC2FC028B1EF4C4CD033DCB00C0B471C30B35ABC13C2A8B682D70CCA2CC74DFBBEE46CDFAA54CCB0556B3BD0C34805C986FED66F1BDF3FC989BA01F2F34470EE3A7DA71016E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D0CF1E6ECE60E49D19BB57C1A432E805F39BB4F65C366741E4F03FA54FBD9071400000000000000000000000000000000000000000000000000000000000001A0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000203D2DD609088F4A660225913296A5D392051FCCC6CCBA9C74E46DE2A5E6CBF3D7733483953F4283ADF7DEE7D082601B641B14A85B71D4FE7D6584BF2FED620904000000000000000000000000000000000000000000000000000000000000001B00000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000106E080211E40200000000000022480A2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F12240A2060F3ED6948B113B8B528C6F79D33F5A40544AD5330132A2ABFD47A18A147D84910012A0C0890D2D9FA0510C8BD9DD901320962616E64636861696E000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000007A00000000000000000000000000000000000000000000000000000000000000EE0000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000002E400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001E000000000000000000000000000000000000000000000000000000000000001CE000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002200000002464200000010324B4D43424C415A4D3554453256504700000000000003E800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000005F566759000000000000000000000000000000000000000000000000000000005F56675C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000004506A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000002A2C1302062844B84E96DB63A6924AA593F66A9E8A535CF657DE4D1F86CFEF8058B00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000002A2301E07C9ED7015E98CBC234AEB87003C05AF21F4273EEE8C3F55BF668AECB4D000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000002A2B6936B0BB87A5579BD57C790C2A191ECF70C707F2C7493356AFD32489C48B07C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000002A261E55C6C45B1A9E9B86C32BB19BF819A7CB684AABD7FA4BC8C87792DAE52D38F00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002A25D52D5033592D37ECCA65B227BF3AF502967E0833BB867DBBE6AA0848285BFEB00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000002E33DE917D101D39159FB448360B702BC1C8778975B81CEBC8BE73C7F8DA3DE3A79000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000002E400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001E00000000000000000000000000000000000000000000000000000000000000247000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002400000004474F4F4700000010324B4D43424C415A4D3554453256504700000000000003E80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000005F566816000000000000000000000000000000000000000000000000000000005F56681900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000184700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000002A21646BAB59AD79C62A66123C7CBF0B1CE8830336C5F3CB5CC689CC45C5BAA140C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000002A28C3D3FC25F23B7F63ED18C8900FC40582E7ED488B71C7FE19126DCCCDCE08D7600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000002A2B6936B0BB87A5579BD57C790C2A191ECF70C707F2C7493356AFD32489C48B07C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000002A261E55C6C45B1A9E9B86C32BB19BF819A7CB684AABD7FA4BC8C87792DAE52D38F00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002A25D52D5033592D37ECCA65B227BF3AF502967E0833BB867DBBE6AA0848285BFEB00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000002E33DE917D101D39159FB448360B702BC1C8778975B81CEBC8BE73C7F8DA3DE3A79000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000002E400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001E000000000000000000000000000000000000000000000000000000000000002A2000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000044141504C00000010324B4D43424C415A4D3554453256504700000000000003E80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000005F5668A4000000000000000000000000000000000000000000000000000000005F5668A700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000001D880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000002A2420CE1DDED95E4D5240EEB397AAC8C82C372028466EBC5DC3919A0D22C75EDE800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000002A28C3D3FC25F23B7F63ED18C8900FC40582E7ED488B71C7FE19126DCCCDCE08D7600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000002A2B6936B0BB87A5579BD57C790C2A191ECF70C707F2C7493356AFD32489C48B07C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000002A261E55C6C45B1A9E9B86C32BB19BF819A7CB684AABD7FA4BC8C87792DAE52D38F00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002A25D52D5033592D37ECCA65B227BF3AF502967E0833BB867DBBE6AA0848285BFEB00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000002E33DE917D101D39159FB448360B702BC1C8778975B81CEBC8BE73C7F8DA3DE3A79"

INVALID_MULTI_PROOF_VERIFY_ORACLE_DATA = "0x00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000002E445CD72E61F5D79ECC26F8CA024FB86D3A6A925071DDF73CB79D1BBAEA3C5132C47359DC797788AA7A77A27B8B40BF23F5EF60594E34253373DDFB76251240C43866A2417EB63733CC9B7A5CB89EDC98F308EE066FFE6E59E0C6CBE22B700704E2B6A7E0F44ED9C179A47A40F93D5824189A5426D6C3F77692DE28E50E20A33DDAF86E0275A883BDCA2276CC1FE523F4E43C50C5612EB996623D287F80B84CFDA32FA694879095840619F5E49380612BD296FF7E950EAFB66FF654D99CA70869E48DFB8B1F245FAB852685BEEAB33EBB09CD93EA77BDDD9B73AEB833FC2FC028B1EF4C4CD033DCB00C0B471C30B35ABC13C2A8B682D70CCA2CC74DFBBEE46CDFAA54CCB0556B3BD0C34805C986FED66F1BDF3FC989BA01F2F34470EE3A7DA71016E340B9CFFB37A989CA544E6BB780A2C78901D3FB33738768511A30617AFA01D0CF1E6ECE60E49D19BB57C1A432E805F39BB4F65C366741E4F03FA54FBD9071400000000000000000000000000000000000000000000000000000000000001A0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000203D2DD609088F4A660225913296A5D392051FCCC6CCBA9C74E46DE2A5E6CBF3D7733483953F4283ADF7DEE7D082601B641B14A85B71D4FE7D6584BF2FED620904000000000000000000000000000000000000000000000000000000000000001B00000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000106E080211E40200000000000022480A2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003F12240A2060F3ED6948B113B8B528C6F79D33F5A40544AD5330132A2ABFD47A18A147D84910012A0C0890D2D9FA0510C8BD9DD901320962616E64636861696E000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000007A00000000000000000000000000000000000000000000000000000000000000EE0000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000002E400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001E000000000000000000000000000000000000000000000000000000000000001CE000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002200000002464200000010324B4D43424C415A4D3554453256504700000000000003E800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000005F566759000000000000000000000000000000000000000000000000000000005F56675C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000004506A000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000002A2C1302062844B84E96DB63A6924AA593F66A9E8A535CF657DE4D1F86CFEF8058B00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000002A2301E07C9ED7015E98CBC234AEB87003C05AF21F4273EEE8C3F55BF668AECB4D000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000002B2B6936B0BB87A5579BD57C790C2A191ECF70C707F2C7493356AFD32489C48B07C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000002A261E55C6C45B1A9E9B86C32BB19BF819A7CB684AABD7FA4BC8C87792DAE52D38F00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002A25D52D5033592D37ECCA65B227BF3AF502967E0833BB867DBBE6AA0848285BFEB00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000002E33DE917D101D39159FB448360B702BC1C8778975B81CEBC8BE73C7F8DA3DE3A79000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000002E400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001E00000000000000000000000000000000000000000000000000000000000000247000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002400000004474F4F4700000010324B4D43424C415A4D3554453256504700000000000003E80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000005F566816000000000000000000000000000000000000000000000000000000005F56681900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000184700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000002A21646BAB59AD79C62A66123C7CBF0B1CE8830336C5F3CB5CC689CC45C5BAA140C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000002A28C3D3FC25F23B7F63ED18C8900FC40582E7ED488B71C7FE19126DCCCDCE08D7600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000002A2B6936B0BB87A5579BD57C790C2A191ECF70C707F2C7493356AFD32489C48B07C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000002A261E55C6C45B1A9E9B86C32BB19BF819A7CB684AABD7FA4BC8C87792DAE52D38F00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002A25D52D5033592D37ECCA65B227BF3AF502967E0833BB867DBBE6AA0848285BFEB00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000002E33DE917D101D39159FB448360B702BC1C8778975B81CEBC8BE73C7F8DA3DE3A79000000000000000000000000000000000000000000000000000000000000072000000000000000000000000000000000000000000000000000000000000002E400000000000000000000000000000000000000000000000000000000000000A000000000000000000000000000000000000000000000000000000000000001E000000000000000000000000000000000000000000000000000000000000002A2000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000A0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000044141504C00000010324B4D43424C415A4D3554453256504700000000000003E80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000005F5668A4000000000000000000000000000000000000000000000000000000005F5668A700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000966726F6D5F7363616E00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000001D880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000002A2420CE1DDED95E4D5240EEB397AAC8C82C372028466EBC5DC3919A0D22C75EDE800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000002A28C3D3FC25F23B7F63ED18C8900FC40582E7ED488B71C7FE19126DCCCDCE08D7600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000002A2B6936B0BB87A5579BD57C790C2A191ECF70C707F2C7493356AFD32489C48B07C00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000002A261E55C6C45B1A9E9B86C32BB19BF819A7CB684AABD7FA4BC8C87792DAE52D38F00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000002A25D52D5033592D37ECCA65B227BF3AF502967E0833BB867DBBE6AA0848285BFEB00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002A00000000000000000000000000000000000000000000000000000000000002E33DE917D101D39159FB448360B702BC1C8778975B81CEBC8BE73C7F8DA3DE3A79"

EXPECTED_MULTI_RELAY_RESULT = [
    [
        [
            "from_scan",
            "2",
            "0x00000002464200000010324b4d43424c415a4d3554453256504700000000000003e8",
            "1",
            "1",
        ],
        ["from_scan", "1", "1", 1599498073, 1599498076, "1", "0x000000000004506a"],
    ],
    [
        [
            "from_scan",
            "2",
            "0x00000004474f4f4700000010324b4d43424c415a4d3554453256504700000000000003e8",
            "1",
            "1",
        ],
        ["from_scan", "2", "1", 1599498262, 1599498265, "1", "0x0000000000184700"],
    ],
    [
        [
            "from_scan",
            "2",
            "0x000000044141504c00000010324b4d43424c415a4d3554453256504700000000000003e8",
            "1",
            "1",
        ],
        ["from_scan", "3", "1", 1599498404, 1599498407, "1", "0x000000000001d880"],
    ],
]

# Deploy Bridge contract with a validator set consisting of 1 validator
@pytest.fixture(scope="module")
def singlebridge():
    return accounts[0].deploy(Bridge, SINGLE_VALIDATOR_SET)


# Deploy MockReceiver contract
@pytest.fixture(scope="module")
def mockreceiver(singlebridge):
    return accounts[0].deploy(MockReceiver, singlebridge)


def test_bridge_relayandmultiverify_success(singlebridge, mockreceiver):
    tx = mockreceiver.relayAndMultiSafe(VALID_MULTI_PROOF)
    assert tx.status == 1
    assert (
        singlebridge.oracleStates(740)
        == "0x866a2417eb63733cc9b7a5cb89edc98f308ee066ffe6e59e0c6cbe22b700704e"
    )
    for i in range(len(EXPECTED_MULTI_RELAY_RESULT)):
        req = mockreceiver.latestRequests(i)
        res = mockreceiver.latestResponses(i)
        assert [
            req["clientID"],
            req["oracleScriptID"],
            req["params"],
            req["askCount"],
            req["minCount"],
        ] == EXPECTED_MULTI_RELAY_RESULT[i][0]
        assert [
            res["clientID"],
            res["requestID"],
            res["ansCount"],
            int(res["requestTime"]),
            int(res["resolveTime"]),
            res["resolveStatus"],
            res["result"],
        ] == EXPECTED_MULTI_RELAY_RESULT[i][1]


def test_bridge_relayandmultiverify_invalid_oracle_state(mockreceiver):
    with brownie.reverts("RELAY_ORACLE_STATE_FAILED"):
        tx = mockreceiver.relayAndMultiSafe(INVALID_MULTI_PROFF_ORACLE_STATE)
        assert tx.status == 0


def test_bridge_relayandmultiverify_invalid_verify_oracle_data(mockreceiver):
    with brownie.reverts("VERIFY_ORACLE_DATA_FAILED"):
        tx = mockreceiver.relayAndMultiSafe(INVALID_MULTI_PROOF_VERIFY_ORACLE_DATA)
        assert tx.status == 0
